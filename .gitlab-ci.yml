stages:
  - build
  - test
  - docker
  - deploy

build:
  stage: build
  image: maven:3.9.1-openjdk-17
  script:
    - mvn clean package -DskipTests

test:
  stage: test
  image: maven:3.9.1-openjdk-17
  script:
    - mvn test

docker_build:
  stage: docker
  runs-on: ubuntu-latest
  env:
    AWS_ECR_REPOSITORY: ${{ secrets.AWS_ECR_REPOSITORY }}
    IMAGE_TAG: ${{ secrets.IMAGE_TAG }}
    AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  steps:
    - uses: actions/checkout@v3

    # Construire IMAGE_NAME
    - name: Set IMAGE_NAME
      run: |
        echo "IMAGE_NAME=$AWS_ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

    # VÃ©rifier
    - run: echo "Building Docker image $IMAGE_NAME"

    # Login ECR
    - run: |
        aws ecr get-login-password --region $AWS_DEFAULT_REGION \
        | docker login --username AWS --password-stdin $AWS_ECR_REPOSITORY

    # Build et push Docker
    - run: |
        docker build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

deploy:
  stage: deploy
  image: amazon/aws-cli:latest
  script:
    - aws ecs update-service --cluster $AWS_ECS_CLUSTER --service $AWS_ECS_SERVICE --force-new-deployment --region $AWS_DEFAULT_REGION
